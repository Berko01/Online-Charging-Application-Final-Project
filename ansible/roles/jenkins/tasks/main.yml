---
- name: Gerekli paketleri yükle
  apt:
    name:
      - openjdk-17-jre
      - git
      - curl
    state: present
    update_cache: yes

- name: Jenkins kullanıcı ve grubunu oluştur
  user:
    name: "{{ jenkins_user }}"
    create_home: yes
    shell: /bin/bash

- name: Jenkins ana dizinini oluştur
  file:
    path: "{{ jenkins_home }}"
    state: directory
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: '0755'

- name: Plugins dizinini oluştur
  file:
    path: "{{ plugins_dir }}"
    state: directory
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: '0755'

- name: jcasc.yaml dosyasını kopyala
  copy:
    src: "{{ playbook_dir }}/roles/jenkins/files/jcasc.yaml"
    dest: "{{ jcasc_path }}"
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: '0644'
    force: yes


- name: Plugin listesini kopyala
  copy:
    src: jenkins_plugins.txt
    dest: "{{ jenkins_home }}/jenkins_plugins.txt"
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: '0644'

- name: Jenkins WAR dosyasını indir
  get_url:
    url: "{{ jenkins_url }}"
    dest: "{{ jenkins_home }}/jenkins.war"
    mode: '0755'

- name: Plugin manager jar dosyasını indir
  get_url:
    url: "{{ plugin_manager_url }}"
    dest: "{{ jenkins_home }}/jenkins-plugin-manager.jar"
    mode: '0755'

- name: Gerekli Jenkins pluginlerini indir (plugin dosyasından)
  command: >
    java -jar {{ jenkins_home }}/jenkins-plugin-manager.jar
    --war {{ jenkins_home }}/jenkins.war
    --plugin-download-directory {{ plugins_dir }}
    --plugin-file {{ jenkins_home }}/jenkins_plugins.txt
  args:
    creates: "{{ plugins_dir }}/configuration-as-code.jpi"

- name: Systemd servisi için jenkins.service dosyasını oluştur
  copy:
    dest: /etc/systemd/system/jenkins.service
    content: |
      [Unit]
      Description=Jenkins WAR Service
      After=network.target

      [Service]
      Type=simple
      User={{ jenkins_user }}
      Environment="JENKINS_HOME={{ jenkins_home }}"
      Environment="CASC_JENKINS_CONFIG={{ jcasc_path }}"
      ExecStart=/usr/bin/java -jar {{ jenkins_home }}/jenkins.war --httpPort=8080 --webroot={{ jenkins_home }}/war
      Restart=always

      [Install]
      WantedBy=multi-user.target
  notify:
    - daemon-reload

- name: Jenkins servisini başlat ve etkinleştir
  systemd:
    name: jenkins
    enabled: true
    state: started

- name: /opt/secrets dizinini oluştur
  file:
    path: /opt/secrets
    state: directory
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: '0755'

- name: kubectl kurulum dosyasını indir
  get_url:
    url: https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl
    dest: /usr/local/bin/kubectl
    mode: '0755'
